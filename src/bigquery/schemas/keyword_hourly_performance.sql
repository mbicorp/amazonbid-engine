-- =============================================================================
-- keyword_hourly_performance テーブル
--
-- Amazon Marketing Stream対応用の時間帯別キーワードパフォーマンステーブル
-- 将来の時間帯×配置最適化のためのプレースホルダスキーマ
--
-- 使用目的:
-- - 時間帯別のパフォーマンス分析
-- - 配置（placement）別の最適化
-- - Amazon Marketing Streamからのリアルタイムデータ取り込み
--
-- 注: このテーブルは将来のAmazon Marketing Stream対応時に使用予定
--     現時点では手動でのデータ投入は不要
-- =============================================================================

CREATE TABLE IF NOT EXISTS `${project_id}.${dataset}.keyword_hourly_performance` (
  -- =====================================================================
  -- 識別キー
  -- =====================================================================
  -- キーワード識別子
  campaign_id STRING NOT NULL,
  ad_group_id STRING NOT NULL,
  keyword_id STRING NOT NULL,

  -- 時間軸
  date DATE NOT NULL,                          -- 日付 (JST)
  hour INT64 NOT NULL,                         -- 時間帯 (0-23, JST)

  -- =====================================================================
  -- キーワード情報
  -- =====================================================================
  asin STRING,                                 -- 対象ASIN
  keyword_text STRING,                         -- キーワードテキスト
  match_type STRING,                           -- マッチタイプ (EXACT/PHRASE/BROAD)

  -- =====================================================================
  -- 配置情報
  -- =====================================================================
  placement STRING,                            -- 配置タイプ (TOP_OF_SEARCH/REST_OF_SEARCH/PRODUCT_PAGE)

  -- =====================================================================
  -- パフォーマンス指標
  -- =====================================================================
  impressions INT64 DEFAULT 0,                 -- インプレッション数
  clicks INT64 DEFAULT 0,                      -- クリック数
  cost FLOAT64 DEFAULT 0.0,                    -- 広告費用 (USD)
  orders INT64 DEFAULT 0,                      -- 注文数
  sales FLOAT64 DEFAULT 0.0,                   -- 売上 (USD)
  units_sold INT64 DEFAULT 0,                  -- 販売個数

  -- =====================================================================
  -- 計算指標（取り込み時に算出）
  -- =====================================================================
  ctr FLOAT64,                                 -- CTR = clicks / impressions
  cvr FLOAT64,                                 -- CVR = orders / clicks
  acos FLOAT64,                                -- ACOS = cost / sales
  cpc FLOAT64,                                 -- CPC = cost / clicks
  roas FLOAT64,                                -- ROAS = sales / cost

  -- =====================================================================
  -- 入札情報
  -- =====================================================================
  bid FLOAT64,                                 -- 適用されていた入札額

  -- =====================================================================
  -- メタ情報
  -- =====================================================================
  ingested_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP(), -- データ取り込み日時
  source STRING DEFAULT 'MARKETING_STREAM',    -- データソース

  -- =====================================================================
  -- 主キー制約（論理的）
  -- =====================================================================
  -- PRIMARY KEY: (campaign_id, ad_group_id, keyword_id, date, hour, placement)
  -- ※BigQueryはPRIMARY KEY制約をサポートしないため、コメントで記載
)
PARTITION BY date
CLUSTER BY campaign_id, keyword_id, hour
OPTIONS (
  description = 'Amazon Marketing Stream用の時間帯別キーワードパフォーマンステーブル。時間帯×配置の最適化分析に使用。'
);

-- =============================================================================
-- 補足情報
-- =============================================================================
--
-- 1. パーティション設計
--    - date列でパーティション化（日別）
--    - 古いデータは自動的にアーカイブ可能
--
-- 2. クラスタリング設計
--    - campaign_id, keyword_id, hourでクラスタリング
--    - 時間帯別の分析クエリを高速化
--
-- 3. 想定されるクエリパターン
--    - 特定キーワードの時間帯別パフォーマンス
--    - 配置別のACoS比較
--    - 時間帯別の最適入札額算出
--
-- 4. Amazon Marketing Stream連携時の注意
--    - データはニアリアルタイム（数分〜数十分遅延）
--    - 重複排除の仕組みが必要（MERGE文推奨）
--    - タイムゾーンはJSTに変換して格納
-- =============================================================================
